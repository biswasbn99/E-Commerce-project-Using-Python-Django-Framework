{% extends "homepage/base.html" %}
{% block title %}Message from {{ message.name }} - Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <!-- Back Button -->
      <div class="mb-3">
        <a href="{% url 'contact_messages' %}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-2"></i>Back to Messages
        </a>
      </div>

      <div class="row">
        <!-- Message Details -->
        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                  <i class="fas fa-envelope me-2"></i>
                  Message from {{ message.name }}
                </h5>
                <div>
                  {% if message.admin_reply %}
                    <span class="badge bg-success">Replied</span>
                  {% elif message.is_read %}
                    <span class="badge bg-info">Read</span>
                  {% else %}
                    <span class="badge bg-warning">Unread</span>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="card-body">
              <!-- Message Info -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <h6 class="text-muted mb-1">From:</h6>
                  <p class="fw-bold">{{ message.name }}</p>
                </div>
                <div class="col-md-6">
                  <h6 class="text-muted mb-1">Email:</h6>
                  <p><a href="mailto:{{ message.email }}">{{ message.email }}</a></p>
                </div>
              </div>
              
              <div class="row mb-4">
                <div class="col-md-6">
                  <h6 class="text-muted mb-1">Received:</h6>
                  <p>{{ message.created_at|date:"F d, Y \a\t h:i A" }}</p>
                </div>
                {% if message.replied_at %}
                <div class="col-md-6">
                  <h6 class="text-muted mb-1">Replied:</h6>
                  <p>{{ message.replied_at|date:"F d, Y \a\t h:i A" }}</p>
                </div>
                {% endif %}
              </div>

              <!-- Original Message -->
              <div class="mb-4">
                <h6 class="text-muted mb-2">Message:</h6>
                <div class="border rounded p-3 bg-light">
                  <p class="mb-0" style="white-space: pre-wrap;">{{ message.message }}</p>
                </div>
              </div>

              <!-- Admin Reply Section -->
              <div class="border-top pt-4">
                <h6 class="text-muted mb-3">Admin Reply:</h6>
                {% if message.admin_reply %}
                  <div class="alert alert-success">
                    <h6 class="alert-heading">Previous Reply:</h6>
                    <p class="mb-0" style="white-space: pre-wrap;">{{ message.admin_reply }}</p>
                    <hr>
                    <small class="text-muted">Replied on {{ message.replied_at|date:"F d, Y \a\t h:i A" }}</small>
                  </div>
                {% endif %}

                <!-- Reply Form -->
                <form method="post">
                  {% csrf_token %}
                  <div class="mb-3">
                    <label for="admin_reply" class="form-label">
                      {% if message.admin_reply %}Update Reply:{% else %}Send Reply:{% endif %}
                    </label>
                    <textarea name="admin_reply" id="admin_reply" class="form-control" rows="6" 
                              placeholder="Type your reply here..." required>{{ message.admin_reply }}</textarea>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">
                      <i class="fas fa-paper-plane me-2"></i>
                      {% if message.admin_reply %}Update Reply{% else %}Send Reply{% endif %}
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="insertTemplate()">
                      <i class="fas fa-magic me-2"></i>Use Template
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar Actions -->
        <div class="col-lg-4">
          <div class="card shadow-sm">
            <div class="card-header">
              <h6 class="mb-0">Actions</h6>
            </div>
            <div class="card-body">
              <!-- Mark Read/Unread -->
              <button type="button" class="btn btn-outline-{% if message.is_read %}warning{% else %}success{% endif %} w-100 mb-3" 
                      onclick="toggleReadStatus({{ message.id }}, {{ message.is_read|yesno:'true,false' }})">
                {% if message.is_read %}
                  <i class="fas fa-envelope me-2"></i>Mark as Unread
                {% else %}
                  <i class="fas fa-envelope-open me-2"></i>Mark as Read
                {% endif %}
              </button>

              <!-- Email Client -->
              <a href="mailto:{{ message.email }}?subject=Re: Your message to Yotta Plus Shop&body=Dear {{ message.name }},%0A%0AThank you for contacting us.%0A%0ABest regards,%0AYotta Plus Shop Team" 
                 class="btn btn-outline-primary w-100">
                <i class="fas fa-external-link-alt me-2"></i>Open in Email Client
              </a>
            </div>
          </div>

          <!-- Quick Reply Templates -->
          <div class="card shadow-sm mt-3">
            <div class="card-header">
              <h6 class="mb-0">Quick Templates</h6>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <button type="button" class="btn btn-outline-info btn-sm" onclick="useTemplate('thank-you')">
                  Thank You Reply
                </button>
                <button type="button" class="btn btn-outline-info btn-sm" onclick="useTemplate('more-info')">
                  Request More Info
                </button>
                <button type="button" class="btn btn-outline-info btn-sm" onclick="useTemplate('resolved')">
                  Issue Resolved
                </button>
                <button type="button" class="btn btn-outline-info btn-sm" onclick="useTemplate('forwarded')">
                  Forwarded to Team
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Message</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this message from <strong>{{ message.name }}</strong>? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="post" action="{% url 'delete_contact_message' message.id %}" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
function toggleReadStatus(messageId, isRead) {
  fetch(`/adminpanel/messages/${messageId}/mark-read/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: `action=${isRead ? 'mark_unread' : 'mark_read'}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    }
  })
  .catch(error => console.error('Error:', error));
}

function deleteMessage() {
  new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function useTemplate(templateType) {
  const textarea = document.getElementById('admin_reply');
  const customerName = '{{ message.name }}';
  
  let template = '';
  
  switch(templateType) {
    case 'thank-you':
      template = `Dear ${customerName},

Thank you for contacting Yotta Plus Shop. We appreciate you taking the time to reach out to us.

We have received your message and will get back to you as soon as possible.

Best regards,
Yotta Plus Shop Customer Service Team`;
      break;
      
    case 'more-info':
      template = `Dear ${customerName},

Thank you for your message. To better assist you, could you please provide us with additional information about your inquiry?

This will help us give you the most accurate and helpful response.

Looking forward to hearing from you.

Best regards,
Yotta Plus Shop Customer Service Team`;
      break;
      
    case 'resolved':
      template = `Dear ${customerName},

Thank you for contacting us. We're pleased to inform you that your inquiry has been resolved.

If you have any additional questions or concerns, please don't hesitate to reach out to us.

Best regards,
Yotta Plus Shop Customer Service Team`;
      break;
      
    case 'forwarded':
      template = `Dear ${customerName},

Thank you for your message. We have forwarded your inquiry to the appropriate team who will be able to assist you better.

You can expect a response within 24-48 hours.

Best regards,
Yotta Plus Shop Customer Service Team`;
      break;
  }
  
  textarea.value = template;
  textarea.focus();
}

function insertTemplate() {
  useTemplate('thank-you');
}
</script>

<style>
.card {
  border: none;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.alert {
  border: none;
}

.btn-outline-info {
  font-size: 0.875rem;
}

pre {
  background-color: #f8f9fa;
  padding: 1rem;
  border-radius: 0.375rem;
  border: 1px solid #dee2e6;
}
</style>

{% endblock %}